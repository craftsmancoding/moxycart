<?xml version="1.0" encoding="UTF-8"?>
<model package="moxycart" version="1.0" baseClass="xPDOObject" platform="mysql" defaultEngine="MyISAM">

    <!-- ! Store -->
    <object class="Store" extends="modResource">
        <composite alias="Products" class="Product" local="id" foreign="parent" cardinality="many" owner="local" />
    </object>
    
    <!-- ! Currencies -->    
	<object class="Currency" table="currencies" extends="xPDOObject">
		<field key="currency_id" dbtype="int" precision="4" phptype="integer" null="false" index="pk"  generated="native" />
		<field key="code" dbtype="varchar" precision="10" phptype="string" null="false" />
		<field key="name" dbtype="varchar" precision="256" phptype="string" null="false" />
		<field key="symbol" dbtype="varchar" precision="4" phptype="string" null="true" />
		<field key="seq" dbtype="int" precision="3" phptype="integer" null="true" />

		<index alias="PRIMARY" name="PRIMARY" primary="true" unique="true">
			<column key="currency_id" collation="A" null="false" />
		</index>
		
		<composite alias="Products" class="Product" local="currency_id" foreign="currency_id" cardinality="many" owner="local" />
		<composite alias="Subscription" class="Subscription" local="currency_id" foreign="currency_id" cardinality="many" owner="local" />
	</object>

    <!-- ! Product -->
    <object class="Product" table="products" extends="xPDOObject">
        <field key="product_id" dbtype="int" precision="11" phptype="integer" null="false" index="pk"  generated="native" />
        <field key="store_id" dbtype="int" precision="11" phptype="integer" null="true" />
        <field key="currency_id" dbtype="int" precision="4" phptype="integer" null="true" />
        <field key="name" dbtype="varchar" precision="60" phptype="string" null="false" />
        <field key="description" dbtype="varchar" precision="255" phptype="string" null="true" />
        <field key="type" dbtype="enum" precision="'regular','subscription','download'" phptype="string" null="true" />
        <field key="sku" dbtype="varchar" precision="20" phptype="string" null="false" />

        <field key="track_inventory" dbtype="tinyint" precision="1" phptype="integer" null="false" default="0"/>
        <field key="inventory_qty" dbtype="int" precision="11" phptype="integer" null="false" />
        <field key="alert_qty" dbtype="int" precision="11" phptype="integer" null="false" />

        <field key="price" dbtype="decimal" precision="8,2" phptype="float" null="true" />
        <field key="category_id" dbtype="int" precision="11" phptype="integer" null="true" />

        <!-- regular products (tangible) -->        
        <field key="length" dbtype="decimal" precision="12,4" phptype="float" null="true" />
        <field key="width" dbtype="decimal" precision="12,4" phptype="float" null="true" />
        <field key="height" dbtype="decimal" precision="12,4" phptype="float" null="true" />
        <field key="weight" dbtype="decimal" precision="12,4" phptype="float" null="true" />
        <field key="volume" dbtype="decimal" precision="12,4" phptype="float" null="true" />
        <field key="length_unit_id" dbtype="int" precision="11" phptype="integer" null="false" />
        <field key="weight_unit_id" dbtype="int" precision="11" phptype="integer" null="false" />
        <field key="volume_unit_id" dbtype="int" precision="11" phptype="integer" null="false" />
        
        <!-- subscription/membership products -->
        <field key="interval_unit" dbtype="enum" precision="'hours','days','weeks','years'" phptype="string" null="false" />
        <field key="billing_interval" dbtype="int" precision="3" phptype="integer" null="false" default="1"/>
        <field key="user_group_id" dbtype="int" precision="11" phptype="integer" null="true" />
        <field key="role_id" dbtype="int" precision="11" phptype="integer" null="true" />

        <!-- downloadable products (link to a MODX static resource)-->
        <field key="payload_id" dbtype="int" precision="11" phptype="integer" null="true"/>
        
        <field key="author_id" dbtype="int" precision="11" phptype="integer" null="true" />
		<field key="timestamp_created" dbtype="timestamp" phptype="timestamp" null="true" default="CURRENT_TIMESTAMP" />
		<field key="timestamp_modified" dbtype="timestamp" phptype="timestamp" null="true" />
        
        
        
		<index alias="PRIMARY" name="PRIMARY" primary="true" unique="true">
			<column key="product_id" collation="A" null="false" />
		</index>
        <index alias="sku" name="sku" primary="false" unique="true">
			<column key="sku" collation="A" null="true" />
		</index>
		
		<aggregate alias="Store" class="Store" local="store_id" foreign="id" cardinality="one" owner="foreign" />
		<aggregate alias="Currency" class="Currency" local="currency_id" foreign="currency_id" cardinality="one" owner="foreign" />
        <aggregate alias="WeightUnit" class="Unit" local="weight_unit_id" foreign="unit_id" cardinality="one" owner="foreign" />
		<aggregate alias="LengthUnit" class="Unit" local="length_unit_id" foreign="unit_id" cardinality="one" owner="foreign" />
		<aggregate alias="VolumeUnit" class="Unit" local="volume_unit_id" foreign="unit_id" cardinality="one" owner="foreign" />
		<aggregate alias="Payload" class="modResource" local="payload_id" foreign="id" cardinality="one" owner="foreign" />
        <aggregate alias="Author" class="modUser" local="author_id" foreign="id" cardinality="one" owner="foreign" />
        <aggregate alias="UserGroup" class="modUserGroup" local="user_group_id" foreign="id" cardinality="one" owner="foreign" />
        <aggregate alias="Role" class="modUserGroupRole" local="role_id" foreign="id" cardinality="one" owner="foreign" />
		<aggregate alias="Category" class="Category" local="category_id" foreign="category_id" cardinality="one" owner="foreign" />

        <composite alias="Variants" class="ProductVariant" local="product_id" foreign="product_id" cardinality="many" owner="local" />
    </object>


	<!-- ! Unit -->
	<object class="Unit" table="units" extends="xPDOObject">
		<field key="unit_id" dbtype="int" precision="11" phptype="integer" null="false" index="pk"  generated="native" />
		<field key="name" dbtype="varchar" precision="16" phptype="string" null="false" />
		<field key="abbreviation" dbtype="varchar" precision="16" phptype="string" null="false" />
		<field key="description" dbtype="varchar" precision="255" phptype="string" null="true" />
		<field key="type" dbtype="enum" precision="'mass','volume','length','area','other'" phptype="string" null="true" />

		<index alias="PRIMARY" name="PRIMARY" primary="true" unique="true">
			<column key="unit_id" collation="A" null="false" />
		</index>
		
		<composite alias="Products" class="Product" local="unit_id" foreign="weight_unit_id" cardinality="many" owner="local" />
		<composite alias="Products" class="Product" local="unit_id" foreign="length_unit_id" cardinality="many" owner="local" />
		<composite alias="Products" class="Product" local="unit_id" foreign="volume_unit_id" cardinality="many" owner="local" />
	</object>


	<!-- ! Variation Types -->
	<!-- eg. "Color", "Size", "Material" -->
	<object class="VariationType" table="variation_types" extends="xPDOObject">
		<field key="vtype_id" dbtype="int" precision="11" phptype="integer" null="false" index="pk"  generated="native" />
		<field key="name" dbtype="varchar" precision="16" phptype="string" null="false" />
		<field key="description" dbtype="varchar" precision="255" phptype="string" null="true" />
		<field key="seq" dbtype="int" precision="4" phptype="integer" null="true" />

		<index alias="PRIMARY" name="PRIMARY" primary="true" unique="true">
			<column key="variation_id" collation="A" null="false" />
		</index>
		
		<composite alias="Terms" class="VariationTerm" local="vtype_id" foreign="vtype_id" cardinality="many" owner="local" />
	</object>

    <!-- ! Variation Terms -->
    <!-- e.g. "Small", "Medium", "Large" -->
	<object class="VariationTerm" table="variation_terms" extends="xPDOObject">
    	<field key="vterm_id" dbtype="int" precision="11" phptype="integer" null="false" index="pk"  generated="native" />
		<field key="vtype_id" dbtype="int" precision="11" phptype="integer" null="false"/>
		<field key="name" dbtype="varchar" precision="255" phptype="string" null="false" />
		<field key="sku_prefix" dbtype="varchar" precision="16" phptype="string" null="false" />
		<field key="sku_suffix" dbtype="varchar" precision="16" phptype="string" null="false" />
		<field key="seq" dbtype="tinyint" precision="3" phptype="integer" null="true" />
		
		<index alias="PRIMARY" name="PRIMARY" primary="true" unique="true">
			<column key="vterm_id" collation="A" null="false" />
		</index>

        <aggregate alias="Type" class="VariationType" local="vtype_id" foreign="vtype_id" cardinality="one" owner="foreign" />
	</object>

	<!-- ! Product Variation Types -->
	<!-- 
	e.g. says "this product varies by Color, Size, and Material 
	is_variant: if 1, this means that price, qty, etc. will change for the product 
	is_variant: if 0, then the options here are just aesthetic options
	-->
	<object class="ProductVariationTypes" table="product_variation_types" extends="xPDOSimpleObject">
		<field key="product_id" dbtype="int" precision="11" phptype="integer" null="false"/>
		<field key="vtype_id" dbtype="int" precision="11" phptype="integer" null="false"/>
        <field key="name" dbtype="varchar" precision="255" phptype="string" null="false" />
        <field key="seq" dbtype="tinyint" precision="3" phptype="integer" null="true" />
		<field key="is_variant" dbtype="tinyint" precision="1" phptype="integer" null="false" default="0" />
		<!-- field key="variation_fields" dbtype="text" phptype="string" null="false" default="0" comment="List of fields that will vary"/-->
		<index alias="PRIMARY" name="PRIMARY" primary="true" unique="true">
			<column key="id" collation="A" null="false" />
		</index>
		
        <aggregate alias="Type" class="VariationType" local="vtype_id" foreign="vtype_id" cardinality="one" owner="foreign" />
        <aggregate alias="Product" class="Product" local="product_id" foreign="product_id" cardinality="one" owner="foreign" />
	</object>
	
	<!-- ! Product Variants -->
	<!-- 
        use this to limit which terms are availabe for a given variation type 
        e.g. maybe size only comes in L and XL
	-->
	<object class="ProductVariantTerm" table="product_variant_terms" extends="xPDOSimpleObject">
		<field key="product_id" dbtype="int" precision="11" phptype="integer" null="false"/>
        <field key="vterm_id" dbtype="int" precision="11" phptype="integer" null="false"/>
		<field key="name" dbtype="varchar" precision="255" phptype="string" null="false" />
		<field key="seq" dbtype="int" precision="11" phptype="integer" null="true" />

		<index alias="PRIMARY" name="PRIMARY" primary="true" unique="true">
			<column key="id" collation="A" null="false" />
		</index>

        <aggregate alias="Term" class="Term" local="term_id" foreign="term_id" cardinality="one" owner="foreign" />
	</object>
	
	<!-- ! Variation Matrix -->
	<!--
	The mother lode: here is where we show what actually varies.
	The tricky
	-->
	<object class="ProductVariant" table="product_variants" extends="xPDOSimpleObject">
		<field key="product_id" dbtype="int" precision="11" phptype="integer" null="false"/>
        <field key="criteria" dbtype="text" phptype="string" null="true" comment="contains a list of the vterm_ids"/>


		<index alias="PRIMARY" name="PRIMARY" primary="true" unique="true">
			<column key="id" collation="A" null="false" />
		</index>

        <aggregate alias="Product" class="Product" local="product_id" foreign="product_id" cardinality="one" owner="foreign" />
	</object>	
	
	<!-- ! Taxonomies -->
	<!-- 
	All for searching/finding our products
	-->
	<object class="Taxonomy" table="taxonomies" extends="xPDOObject">
    	<field key="taxonomy_id" dbtype="int" precision="11" phptype="integer" null="false" index="pk"  generated="native" />
		<field key="parent_id" dbtype="int" precision="11" attributes="unsigned" phptype="integer" null="true" />
		<field key="name" dbtype="varchar" precision="255" phptype="string" null="false" />
		<field key="seq" dbtype="tinyint" precision="3" phptype="integer" null="true" />
		<field key="grp" dbtype="varchar" precision="16" phptype="string" null="true" />
		
		<index alias="PRIMARY" name="PRIMARY" primary="true" unique="true">
			<column key="taxonomy_id" collation="A" null="false" />
		</index>

		<aggregate alias="Parent" class="Taxonomy" local="parent_id" foreign="taxonomy_id" cardinality="one" owner="foreign" />
		<aggregate alias="Children" class="Taxonomy" local="taxonomy_id" foreign="parent_id" cardinality="many" owner="local" />
		<composite alias="Terms" class="Term" local="taxonomy_id" foreign="taxonomy_id" cardinality="many" owner="local" />
	</object>
    
    
    <!-- ! Terms -->
	<object class="Term" table="terms" extends="xPDOObject">
    	<field key="term_id" dbtype="int" precision="11" phptype="integer" null="false" index="pk"  generated="native" />
		<field key="taxonomy_id" dbtype="int" precision="11" phptype="integer" null="false"/>
		<field key="name" dbtype="varchar" precision="255" phptype="string" null="false" />
		<field key="slug" dbtype="varchar" precision="255" phptype="string" null="false" comment="URL-friendly"/>
		<field key="seq" dbtype="tinyint" precision="3" phptype="integer" null="true" />
		
		<index alias="PRIMARY" name="PRIMARY" primary="true" unique="true">
			<column key="taxonomy_id" collation="A" null="false" />
		</index>

        <aggregate alias="Taxonomy" class="Taxonomy" local="taxonomy_id" foreign="taxonomy_id" cardinality="one" owner="foreign" />
	</object>
    
    <!-- ! ProductTerms -->
	<object class="ProductTerms" table="product_terms" extends="xPDOSimpleObject">
		<field key="product_id" dbtype="int" precision="11" phptype="integer" null="false"/>
        <field key="term_id" dbtype="int" precision="11" phptype="integer" null="false"/>
		<field key="seq" dbtype="tinyint" precision="3" phptype="integer" null="true" />		
		<index alias="PRIMARY" name="PRIMARY" primary="true" unique="true">
			<column key="id" collation="A" null="false" />
		</index>

        <aggregate alias="Term" class="Term" local="term_id" foreign="term_id" cardinality="one" owner="foreign" />
	</object>
	
	
	<!-- ! Coupons -->
	
	<!-- ! Categories (FoxyCart) -->
	<object class="Category" table="categories" extends="xPDOObject">
    	<field key="category_id" dbtype="int" precision="11" phptype="integer" null="false" index="pk"  generated="native" />
		<field key="description" dbtype="varchar" precision="255" phptype="string" null="false" />
		<field key="code" dbtype="varchar" precision="255" phptype="string" null="false" />
		<field key="data" dbtype="text" phptype="string" null="false" />
		<index alias="PRIMARY" name="PRIMARY" primary="true" unique="true">
			<column key="category_id" collation="A" null="false" />
		</index>

		<aggregate alias="Products" class="Product" local="category_id" foreign="category_id" cardinality="one" owner="foreign" />
	</object>	
	    
    <!-- ! Carts -->
    <!-- 
    what if you have multiple currencies in the cart? 
    how to handle variations?
    -->
	<object class="Cart" table="carts" extends="xPDOObject">
    	<field key="cart_id" dbtype="int" precision="11" phptype="integer" null="false" index="pk"  generated="native" />
		<field key="product_id" dbtype="int" precision="11" phptype="integer" null="false"/>

        <field key="price" dbtype="decimal" precision="8,2" phptype="float" null="true" />
        <field key="currency_id" dbtype="int" precision="4" phptype="integer" null="true" />
		<field key="qty" dbtype="int" precision="11" phptype="integer" null="false" default="0"/>

        <field key="info" dbtype="text" phptype="string" null="true" comment="JSON data including varations/options"/>

        <field key="author_id" dbtype="int" precision="11" phptype="integer" null="true" comment="user may not be logged in"/>
		<field key="timestamp_created" dbtype="timestamp" phptype="timestamp" null="true" default="CURRENT_TIMESTAMP" />
		<field key="timestamp_modified" dbtype="timestamp" phptype="timestamp" null="true" />

		
		<index alias="PRIMARY" name="PRIMARY" primary="true" unique="true">
			<column key="taxonomy_id" collation="A" null="false" />
		</index>

        <aggregate alias="Product" class="Product" local="product_id" foreign="product_id" cardinality="one" owner="foreign" />
        <aggregate alias="Author" class="modUser" local="author_id" foreign="id" cardinality="one" owner="foreign" />
        
	</object>
    
    
</model>